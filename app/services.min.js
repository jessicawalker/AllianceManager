const MongoClient=require("mongodb").MongoClient,ObjectId=require("mongodb").ObjectId,dbURL=process.env.DB_URI||"mongodb://localhost";var services=function(app){app.post("/write-record",(function(req,res){var newUserEntry={date:req.body.date,user:req.body.user,claimedSSWar:req.body.claimedSSWar,activeDeclare:req.body.activeDeclare,defenseEarly:req.body.defenseEarly,defenseLive:req.body.defenseLive,offense:req.body.offense,notes:req.body.notes};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").insertOne(newUserEntry,(function(err,response){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS"})))}))}))})),app.get("/read-records",(function(req,res){var sortBy={date:-1,_id:1};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").find().sort(sortBy).toArray((function(err,data){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS",userdata:data})))}))}))})),app.get("/get-userdataByValue",(function(req,res){var date=req.query.date,user=req.query.user,searchDate=""===date?{}:{date:new Date(date)},searchUser=""===user?{}:{user:user},sortBy={date:-1,_id:1};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").find({$and:[searchDate,searchUser]}).sort(sortBy).toArray((function(err,data){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS",userdata:data})))}))}))})),app.get("/get-userdataByDate",(function(req,res){var date=req.query.date,search=""===date?{}:{date:new Date(date)},sortBy={date:-1};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").find(search).sort(sortBy).toArray((function(err,data){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS",userdata:data})))}))}))})),app.get("/get-userdataByUser",(function(req,res){var sortByKey=req.query.sortByKey,user=req.query.user,search=""===user?{}:{user:user},sortBy={date:-1};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").find(search).sort(sortBy).toArray((function(err,data){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS",userdata:data})))}))}))})),app.get("/sort-records",(function(req,res){var sortByKey=req.query.sortByKey,date=req.query.date,search=""===date?{}:{date:date},sortBy;switch(sortByKey){case"date":sortBy={date:-1};break;case"user":sortBy={user:1};break;case"claimedSSWar":sortBy={claimedSSWar:1};break;case"activeDeclare":sortBy={activeDeclare:1};break;case"defenseEarly":sortBy={defenseEarly:1};break;case"defenseLive":sortBy={defenseLive:1};break;case"offense":sortBy={offense:1};break;case"notes":sortBy={notes:1}}MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").find(search).sort(sortBy).toArray((function(err,data){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS",userdata:data})))}))}))})),app.delete("/delete-record",(function(req,res){var userdataID=req.query.userdataID,s_id,search={_id:new ObjectId(userdataID)};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").deleteOne(search,(function(err,response){return err?res.status(200).send(JSON.stringify({msg:"Error: "+err})):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS"})))}))}))})),app.put("/update-record",(function(req,res){var userdataID=req.body.userdataID,date=req.body.date,user=req.body.user,claimedSSWar=req.body.claimedSSWar,activeDeclare=req.body.activeDeclare,defenseEarly=req.body.defenseEarly,defenseLive=req.body.defenseLive,offense=req.body.offense,notes=req.body.notes,s_id,search={_id:new ObjectId(userdataID)},updateData={$set:{date:date,user:user,claimedSSWar:claimedSSWar,activeDeclare:activeDeclare,defenseEarly:defenseEarly,defenseLive:defenseLive,offense:offense,notes:notes}};MongoClient.connect(dbURL,{useUnifiedTopology:!0},(function(err,client){if(err)return res.status(200).send(JSON.stringify({msg:"Error: "+err}));var dbo;client.db("evertale-visunu").collection("userdata").updateOne(search,updateData,(function(err,response){return err?(client.close(),res.status(200).send(JSON.stringify({msg:"Error: "+err}))):(client.close(),res.status(200).send(JSON.stringify({msg:"SUCCESS"})))}))}))}))};module.exports=services;